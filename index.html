<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Date &amp; Time Dictation</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Mono:wght@300;400;500&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f14; --surface:#1a1a24; --surface2:#22222f; --border:#2e2e40;
  --accent:#7c6af7; --accent2:#f7a06a; --accent3:#6af7c0;
  --text:#e8e6f0; --text-muted:#7a7890; --correct:#4ade80; --wrong:#f87171;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:var(--bg); color:var(--text); font-family:'Nunito',sans-serif;
  min-height:100vh; display:flex; flex-direction:column; align-items:center;
  padding:20px 14px;
  background-image:radial-gradient(ellipse at 20% 20%,rgba(124,106,247,0.08) 0%,transparent 50%),
                   radial-gradient(ellipse at 80% 80%,rgba(106,247,192,0.05) 0%,transparent 50%);
}
header{text-align:center;margin-bottom:16px;}
header h1{
  font-family:'Playfair Display',serif;
  font-size:clamp(1.4rem,4vw,2rem);
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
header p{color:var(--text-muted);font-size:0.78rem;margin-top:4px;font-family:'DM Mono',monospace;}

.tts-bar{
  width:100%;max-width:680px;background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:8px 14px;margin-bottom:10px;
  font-family:'DM Mono',monospace;font-size:0.74rem;
  display:flex;align-items:center;gap:8px;
}
.tts-dot{width:7px;height:7px;border-radius:50%;background:#888;flex-shrink:0;}
.tts-dot.ok{background:var(--correct);box-shadow:0 0 5px var(--correct);}
.tts-dot.err{background:var(--wrong);box-shadow:0 0 5px var(--wrong);}
.tts-dot.busy{background:var(--accent2);animation:blink 0.8s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
#ttsMsg{color:var(--text-muted);flex:1;}

/* â”€â”€ TABS â”€â”€ */
.tabs{
  display:flex;gap:5px;margin-bottom:14px;
  background:var(--surface);padding:5px;border-radius:14px;border:1px solid var(--border);
  width:100%;max-width:680px;
}
.tab{
  flex:1;padding:9px 4px;border-radius:10px;border:none;background:transparent;
  color:var(--text-muted);font-family:'Nunito',sans-serif;font-size:0.8rem;font-weight:700;
  cursor:pointer;transition:all 0.2s;text-align:center;
}
.tab.active{background:var(--accent);color:white;box-shadow:0 4px 12px rgba(124,106,247,0.4);}
.tab:hover:not(.active){color:var(--text);background:var(--surface2);}

/* â”€â”€ COMPONENT SELECTOR â”€â”€ */
.selector-panel{
  width:100%;max-width:680px;background:var(--surface);border:1px solid var(--border);
  border-radius:16px;padding:14px 18px;margin-bottom:12px;
}
.selector-title{
  font-size:0.72rem;font-weight:700;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;
}
.chips{display:flex;gap:8px;flex-wrap:wrap;}
.chip{
  padding:7px 14px;border-radius:20px;border:1.5px solid var(--border);
  background:var(--surface2);color:var(--text-muted);
  font-family:'Nunito',sans-serif;font-size:0.82rem;font-weight:700;
  cursor:pointer;transition:all 0.18s;user-select:none;
}
.chip.on{background:var(--accent);border-color:var(--accent);color:white;box-shadow:0 3px 10px rgba(124,106,247,0.35);}
.chip:hover:not(.on){border-color:var(--accent);color:var(--text);}
.selector-hint{font-size:0.72rem;color:var(--text-muted);margin-top:8px;font-family:'DM Mono',monospace;}
.selector-hint span{color:var(--accent2);}

/* â”€â”€ CARD â”€â”€ */
.card{
  width:100%;max-width:680px;background:var(--surface);border:1px solid var(--border);
  border-radius:20px;padding:26px;box-shadow:0 20px 60px rgba(0,0,0,0.4);
}
.counter{font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-muted);text-align:right;margin-bottom:14px;}
.counter span{color:var(--accent);}

.audio-section{
  display:flex;align-items:center;gap:16px;margin-bottom:22px;
  background:var(--surface2);border-radius:14px;padding:16px 18px;border:1px solid var(--border);
}
.play-btn{
  width:56px;height:56px;border-radius:50%;border:none;
  background:linear-gradient(135deg,var(--accent),#5b52d4);
  color:white;font-size:1.3rem;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  box-shadow:0 5px 18px rgba(124,106,247,0.4);position:relative;user-select:none;
}
.play-btn:hover{transform:scale(1.08);}
.play-btn:active{transform:scale(0.94);}
.play-btn.playing::after{
  content:'';position:absolute;inset:-5px;border-radius:50%;
  border:2px solid var(--accent);animation:pulse-ring 1.1s ease-out infinite;
}
@keyframes pulse-ring{0%{transform:scale(1);opacity:0.8}100%{transform:scale(1.55);opacity:0}}
.audio-info{flex:1;}
.audio-info p{font-size:0.83rem;color:var(--text-muted);line-height:1.5;}
.shortcut-row{font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--text-muted);margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;}
kbd{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:0.66rem;color:var(--accent);}
.speed-row{display:flex;align-items:center;gap:7px;margin-top:8px;}
.speed-row label{font-size:0.7rem;color:var(--text-muted);font-family:'DM Mono',monospace;}
.speed-row input[type=range]{flex:1;accent-color:var(--accent);cursor:pointer;}
.speed-val{font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--accent);min-width:32px;}

.sentence-display{
  background:var(--surface2);border:1px solid var(--border);border-radius:11px;
  padding:13px 16px;font-size:0.98rem;line-height:1.8;color:var(--text);
  margin-bottom:16px;min-height:50px;display:none;
}
.blank{display:inline-block;min-width:80px;border-bottom:2px solid var(--accent);margin:0 3px;vertical-align:bottom;}
.revealed{color:var(--accent2);font-weight:700;}

.input-section{margin-bottom:16px;}
.input-label{display:block;font-size:0.7rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:7px;}
.answer-input{
  width:100%;background:var(--surface2);border:2px solid var(--border);
  border-radius:11px;padding:13px 16px;color:var(--text);
  font-family:'DM Mono',monospace;font-size:0.98rem;transition:all 0.2s;outline:none;
}
.answer-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,106,247,0.15);}
.answer-input.correct{border-color:var(--correct);background:rgba(74,222,128,0.07);}
.answer-input.wrong{border-color:var(--wrong);background:rgba(248,113,113,0.07);}

.btn-row{display:flex;gap:7px;margin-bottom:12px;}
.btn{padding:11px 16px;border-radius:10px;border:none;font-family:'Nunito',sans-serif;font-weight:700;font-size:0.86rem;cursor:pointer;transition:all 0.17s;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#5b52d4);color:white;flex:1;box-shadow:0 4px 12px rgba(124,106,247,0.3);}
.btn-primary:hover{transform:translateY(-1px);}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{background:var(--border);}
.btn-nav{background:var(--surface2);border:1px solid var(--border);color:var(--text-muted);padding:11px 13px;}
.btn-nav:hover{color:var(--text);background:var(--border);}
.btn-nav:disabled{opacity:0.3;cursor:not-allowed;}

.result-box{display:none;border-radius:12px;padding:14px 18px;margin-top:11px;animation:slide-in 0.24s ease;}
@keyframes slide-in{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.result-box.correct{background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.22);}
.result-box.wrong{background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.22);}
.result-title{font-weight:700;font-size:0.98rem;margin-bottom:9px;}
.result-title.correct{color:var(--correct);}
.result-title.wrong{color:var(--wrong);}
.result-body{font-family:'DM Mono',monospace;font-size:0.85rem;color:var(--text);line-height:1.9;}
.rl{color:var(--text-muted);font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-top:7px;}
.rl:first-child{margin-top:0;}
.hi-wrong{color:var(--wrong);text-decoration:underline wavy;}
.hi-ok{color:var(--correct);}

.stats{display:flex;gap:8px;margin-top:18px;padding-top:14px;border-top:1px solid var(--border);}
.stat{flex:1;text-align:center;background:var(--surface2);border-radius:9px;padding:10px 4px;border:1px solid var(--border);}
.stat-num{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;line-height:1;margin-bottom:2px;}
.stat-label{font-size:0.64rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;}

@media(max-width:500px){
  .card{padding:16px 12px;}
  .chips{gap:6px;}
  .chip{padding:6px 11px;font-size:0.78rem;}
  .btn-row{flex-wrap:wrap;}
  .btn-primary{flex:none;width:100%;}
  .audio-section{flex-direction:column;align-items:flex-start;}
}
</style>
</head>
<body>

<header>
  <h1>ğŸ§ Date &amp; Time Dictation</h1>
  <p>Date &amp; Time Dictation Practice</p>
</header>

<div class="tts-bar">
  <div class="tts-dot" id="ttsDot"></div>
  <div id="ttsMsg">Initializing speech engineâ€¦</div>
</div>

<!-- tabs -->
<div class="tabs">
  <button class="tab active" onclick="switchTab(0)">ğŸ”¤ Phrase</button>
  <button class="tab" onclick="switchTab(1)">ğŸ—£ï¸ Sentence</button>
</div>

<!-- component selector -->
<div class="selector-panel">
  <div class="selector-title">Include in dictation (multi-select)</div>
  <div class="chips">
    <button class="chip" id="chip-weekday" onclick="toggleChip('weekday')">ğŸ“… Weekday</button>
    <button class="chip on" id="chip-date" onclick="toggleChip('date')">ğŸ—“ Date (M+D)</button>
    <button class="chip" id="chip-year" onclick="toggleChip('year')">ğŸ“† Year</button>
    <button class="chip on" id="chip-time" onclick="toggleChip('time')">ğŸ• Time</button>
  </div>
  <div class="selector-hint" id="selectorHint">Active: <span id="hintText">Date (M+D) + Time</span></div>
</div>

<div class="card">
  <div class="counter">Question <span id="itemIndex">1</span> &nbsp;|&nbsp; Done: <span id="totalDone">0</span></div>

  <div class="audio-section">
    <button class="play-btn" id="playBtn" onclick="handlePlay()">â–¶</button>
    <div class="audio-info">
      <p>Click â–¶ to play, then type what you hear and submit.</p>
      <div class="shortcut-row">
        <span><kbd>Ctrl</kbd> Replay</span>
        <span><kbd>Enter</kbd> Submit / Next</span>
        <span><kbd>â†</kbd> Previous</span>
        <span><kbd>â†’</kbd> Next</span>
      </div>
      <div class="speed-row">
        <label>Speed</label>
        <input type="range" id="speedRange" min="0.5" max="1.5" step="0.05" value="0.85" oninput="updateSpeed()">
        <span class="speed-val" id="speedVal">0.85Ã—</span>
      </div>
    </div>
  </div>

  <div class="sentence-display" id="sentenceDisplay"></div>

  <div class="input-section">
    <label class="input-label" id="inputLabel">Type what you hear</label>
    <input class="answer-input" type="text" id="answerInput"
      placeholder="e.g. half past three, Monday March 15th 2024"
      autocomplete="off" autocorrect="off" spellcheck="false">
  </div>

  <div class="btn-row">
    <button class="btn btn-nav" id="prevBtn" onclick="prevItem()" disabled>â—€</button>
    <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()">âœ“ Submit</button>
    <button class="btn btn-secondary" onclick="skipItem()">Skip</button>
    <button class="btn btn-nav" onclick="nextItem()">â–¶</button>
  </div>

  <div class="result-box" id="resultBox">
    <div class="result-title" id="resultTitle"></div>
    <div class="result-body" id="resultBody"></div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-num" id="sTotal" style="color:var(--accent)">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-num" id="sCorrect" style="color:var(--correct)">0</div><div class="stat-label">Correct</div></div>
    <div class="stat"><div class="stat-num" id="sWrong" style="color:var(--wrong)">0</div><div class="stat-label">Wrong</div></div>
    <div class="stat"><div class="stat-num" id="sRate" style="color:var(--accent2)">â€”</div><div class="stat-label">Accuracy</div></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TTS = {
  voice: null, rate: 0.85,
  setStatus(type, msg) {
    document.getElementById('ttsDot').className = 'tts-dot ' + type;
    document.getElementById('ttsMsg').textContent = msg;
  },
  init() {
    if (!('speechSynthesis' in window)) { this.setStatus('err','âŒ Speech not supported. Use Chrome or Edge.'); return; }
    this.setStatus('busy','Loading voicesâ€¦');
    this._load();
    window.speechSynthesis.onvoiceschanged = () => this._load();
  },
  _load() {
    const all = window.speechSynthesis.getVoices();
    if (!all.length) return;
    this.voice = all.find(v=>v.lang==='en-US'&&v.localService)||all.find(v=>v.lang==='en-US')||all.find(v=>v.lang.startsWith('en-GB'))||all.find(v=>v.lang.startsWith('en'))||null;
    this.setStatus('ok', `âœ“ Ready  Voice: ${this.voice?this.voice.name:'default'}  Click â–¶ to play`);
  },
  speak(text) {
    if (!('speechSynthesis' in window)) return;
    const synth = window.speechSynthesis;
    if (!this.voice) this._load();
    synth.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang='en-US'; utt.rate=this.rate; utt.pitch=1; utt.volume=1;
    if (this.voice) utt.voice = this.voice;
    const btn = document.getElementById('playBtn');
    utt.onstart = () => { btn.textContent='â¸'; btn.classList.add('playing'); this.setStatus('busy','ğŸ”Š Playingâ€¦'); };
    utt.onend   = () => { btn.textContent='â–¶'; btn.classList.remove('playing'); this.setStatus('ok','âœ“ Done. Click â–¶ to replay.'); };
    utt.onerror = e => {
      if(e.error==='interrupted'||e.error==='canceled') return;
      btn.textContent='â–¶'; btn.classList.remove('playing');
      const m={'not-allowed':'âŒ Click anywhere on the page first, then play.','network':'âŒ Network error loading voice.','synthesis-failed':'âŒ Synthesis failed. Please refresh.'};
      this.setStatus('err', m[e.error]||`âŒ Error (${e.error}). Please refresh.`);
    };
    try { synth.speak(utt); } catch(ex) { this.setStatus('err','âŒ '+ex.message); }
  }
};
setInterval(()=>{ try{ if(window.speechSynthesis&&!window.speechSynthesis.speaking) window.speechSynthesis.resume(); }catch(e){} },5000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const components = { weekday:false, date:true, year:false, time:true };

function toggleChip(key) {
  const next = !components[key];
  // Must have at least one on
  const onCount = Object.values(components).filter(Boolean).length;
  if (!next && onCount <= 1) return; // prevent all-off
  components[key] = next;
  document.getElementById('chip-'+key).classList.toggle('on', next);
  updateHint();
  // Reset history when selection changes
  hist[0]=[]; hist[1]=[]; hIdx[0]=-1; hIdx[1]=-1;
  loadItem();
}

const COMP_LABELS = { weekday:'Weekday', date:'Date', year:'Year', time:'Time' };
function updateHint() {
  const on = Object.keys(components).filter(k=>components[k]).map(k=>COMP_LABELS[k]);
  document.getElementById('hintText').textContent = on.join(' + ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA GENERATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
function ordinal(n){ return n+(n===1||n===21||n===31?'st':n===2||n===22?'nd':n===3||n===23?'rd':'th'); }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

const NW=['zero','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen','twenty','twenty-one','twenty-two','twenty-three','twenty-four','twenty-five','twenty-six','twenty-seven','twenty-eight','twenty-nine','thirty','thirty-one','thirty-two','thirty-three','thirty-four','thirty-five','thirty-six','thirty-seven','thirty-eight','thirty-nine','forty','forty-one','forty-two','forty-three','forty-four','forty-five','forty-six','forty-seven','forty-eight','forty-nine','fifty','fifty-one','fifty-two','fifty-three','fifty-four','fifty-five','fifty-six','fifty-seven','fifty-eight','fifty-nine'];
function nw(n){ return NW[n]||String(n); }

// Generate each component separately
function makeWeekday(){ return pick(DAYS); }
function makeDate(){ 
  const m=pick(MONTHS), d=rand(1,28), ord=ordinal(d);
  return pick([`${m} ${ord}`, `the ${ord} of ${m}`, `${m} the ${ord}`]);
}
function makeYear(){
  const y = rand(1950, 2035);
  // Natural English year reading
  if(y>=2000 && y<=2009) return `two thousand${y>2000?' and '+nw(y-2000):''}`;
  if(y>=2010) {
    const dec = Math.floor((y-2000)/10)*10;
    const rem = y - 2000 - dec;
    const decWord = nw(dec);
    return rem===0 ? `twenty ${decWord}` : `twenty ${nw(dec+rem)}`;
  }
  // 1950-1999: nineteen fifty, nineteen eighty-four etc.
  const hi = Math.floor(y/100); // 19
  const lo = y % 100;
  const hiWord = nw(hi*10).replace('ty','teen') ; // hacky, use lookup
  const hiWords = {19:'nineteen', 18:'eighteen', 17:'seventeen', 20:'twenty'};
  const loWord = lo===0 ? 'hundred' : (lo<10 ? 'oh '+nw(lo) : nw(lo));
  return `${hiWords[hi]||nw(hi*10)} ${loWord}`;
}
function makeTime(){
  const h=rand(1,12), r=Math.random();
  if(r<0.14){ const ctx=pick(h<=11?['in the morning','','']:['in the afternoon','in the evening','']); return `${nw(h)} o'clock${ctx?' '+ctx:''}`; }
  if(r<0.28){ return pick([`half past ${nw(h)}`,`${nw(h)} thirty`]); }
  if(r<0.42){ const next=h===12?1:h+1; return Math.random()>0.5?`a quarter to ${nw(next)}`:`a quarter past ${nw(h)}`; }
  const m=rand(1,59), next=h===12?1:h+1;
  if(m<30) return pick([`${nw(m)} past ${nw(h)}`,`${nw(h)} ${nw(m)}`]);
  if(m===30) return `half past ${nw(h)}`;
  return pick([`${nw(60-m)} to ${nw(next)}`,`${nw(h)} ${nw(m)}`]);
}

// Build a phrase from selected components
function buildPhrase() {
  const parts = [];
  const answers = {};
  // Natural order: weekday, date(month+day), year, time
  if(components.weekday){ const w=makeWeekday(); parts.push(w); answers.weekday=w; }
  if(components.date){    const d=makeDate();    parts.push(d); answers.date=d; }
  if(components.year){    const y=makeYear();    parts.push(y); answers.year=y; }
  if(components.time){    const t=makeTime();    parts.push(t); answers.time=t; }
  // Join naturally
  let speak = parts.join(', ');
  // If only one component, no comma needed
  if(parts.length===1) speak=parts[0];
  return { type:'phrase', speak, text:speak, answers, parts };
}

// Sentence templates â€” DATE/TIME placeholder will be filled with full phrase
const SENTENCE_TMPLS = [
  "Let's meet on DATETIME.",
  "The party starts at DATETIME.",
  "Can you come on DATETIME?",
  "The meeting is on DATETIME.",
  "The appointment is on DATETIME.",
  "I was born on DATETIME.",
  "She arrived on DATETIME.",
  "The event takes place on DATETIME.",
  "School starts on DATETIME.",
  "The flight is on DATETIME.",
  "The store opens at DATETIME.",
  "The class is on DATETIME.",
  "Can we reschedule to DATETIME?",
  "The deadline is DATETIME.",
  "Please come on DATETIME.",
  "The show starts at DATETIME.",
  "The train leaves at DATETIME.",
  "We need to be there by DATETIME.",
  "The next meeting is on DATETIME.",
  "I have a doctor's visit on DATETIME.",
];

function buildSentence() {
  const phrase = buildPhrase();
  const tpl = pick(SENTENCE_TMPLS);
  const sentence = tpl.replace('DATETIME', phrase.speak);
  // Build display with blank
  const display = tpl.replace('DATETIME', '<span class="blank">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>');
  return { type:'sentence', speak:sentence, sentence, display, phraseText:phrase.speak, answers:phrase.answers };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tab = 0;
const hist = [[], []];
const hIdx = [-1, -1];
const stats = { total:0, correct:0, wrong:0 };
let answered = false;
let lastResultOk = false;

function cur(){ return hist[tab][hIdx[tab]]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function norm(s){
  return s.toLowerCase()
    .replace(/['''`]/g,"'")
    .replace(/[^a-z0-9'\-\s]/g,' ')
    .replace(/\s+/g,' ').trim();
}

// Convert numeric input to spoken English words so "3:30" matches "half past three" etc.
const _NW=['zero','one','two','three','four','five','six','seven','eight','nine','ten',
  'eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen','twenty',
  'twenty-one','twenty-two','twenty-three','twenty-four','twenty-five','twenty-six','twenty-seven',
  'twenty-eight','twenty-nine','thirty','thirty-one','thirty-two','thirty-three','thirty-four',
  'thirty-five','thirty-six','thirty-seven','thirty-eight','thirty-nine','forty','forty-one',
  'forty-two','forty-three','forty-four','forty-five','forty-six','forty-seven','forty-eight',
  'forty-nine','fifty','fifty-one','fifty-two','fifty-three','fifty-four','fifty-five','fifty-six',
  'fifty-seven','fifty-eight','fifty-nine'];
function _nw(n){ return _NW[n]||String(n); }

// Convert a time string like "3:30", "3:00", "15:45" â†’ word equivalents (returns array of candidates)
function timeToWords(str) {
  const m = str.match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return [];
  let h = parseInt(m[1]), min = parseInt(m[2]);
  if (h > 12) h -= 12;
  if (h === 0) h = 12;
  const candidates = [];
  // Always include the "H MM" literal form
  if (min > 0) candidates.push(`${_nw(h)} ${_nw(min)}`);
  // Natural spoken forms
  if (min === 0) {
    candidates.push(`${_nw(h)} o clock`);
    candidates.push(`${_nw(h)} oclock`);
  } else if (min === 30) {
    candidates.push(`half past ${_nw(h)}`);
    candidates.push(`${_nw(h)} thirty`);
  } else if (min === 15) {
    candidates.push(`a quarter past ${_nw(h)}`);
    candidates.push(`quarter past ${_nw(h)}`);
  } else if (min === 45) {
    const next = h === 12 ? 1 : h + 1;
    candidates.push(`a quarter to ${_nw(next)}`);
    candidates.push(`quarter to ${_nw(next)}`);
  } else if (min < 30) {
    candidates.push(`${_nw(min)} past ${_nw(h)}`);
  } else {
    const rem = 60 - min;
    const next = h === 12 ? 1 : h + 1;
    candidates.push(`${_nw(rem)} to ${_nw(next)}`);
  }
  return candidates;
}

// Convert a year number like 1984, 2024 â†’ word equivalents
function yearToWords(y) {
  const candidates = [];
  if (y >= 2000 && y <= 2009) {
    const r = y - 2000;
    candidates.push(r === 0 ? 'two thousand' : `two thousand and ${_nw(r)}`);
    candidates.push(r === 0 ? 'two thousand' : `two thousand ${_nw(r)}`);
  } else if (y >= 2010 && y <= 2099) {
    const lo = y - 2000;
    candidates.push(`twenty ${_nw(lo)}`);
  } else if (y >= 1100 && y <= 1999) {
    const hi = Math.floor(y / 100);
    const lo = y % 100;
    const hiWords = {11:'eleven',12:'twelve',13:'thirteen',14:'fourteen',15:'fifteen',
                     16:'sixteen',17:'seventeen',18:'eighteen',19:'nineteen',20:'twenty',10:'ten'};
    const hiW = hiWords[hi] || _nw(hi);
    if (lo === 0) candidates.push(`${hiW} hundred`);
    else if (lo < 10) { candidates.push(`${hiW} oh ${_nw(lo)}`); candidates.push(`${hiW} ${_nw(lo)}`); }
    else candidates.push(`${hiW} ${_nw(lo)}`);
  }
  return candidates;
}

// Expand numeric expressions in a user input string to word form
function expandNumerics(s) {
  let result = s;
  // Time: 3:30, 11:45 etc
  result = result.replace(/\b(\d{1,2}:\d{2})\b/g, (_, t) => {
    const words = timeToWords(t);
    return words.length ? words[0] : t;
  });
  // Year: 4-digit number 1000â€“2099
  result = result.replace(/\b(1[0-9]{3}|20[0-9]{2})\b/g, (_, y) => {
    const words = yearToWords(parseInt(y));
    return words.length ? words[0] : y;
  });
  // Bare hour: single/double digit followed by am/pm
  result = result.replace(/\b(\d{1,2})\s*(am|pm)\b/gi, (_, h) => `${_nw(parseInt(h))} o clock`);
  // Ordinal date: 15th, 3rd etc â€” already handled by norm stripping punctuation
  return result;
}

function match(user, correct) {
  const c = norm(correct);

  // Generate all possible word-form expansions of user input and test each
  const candidates = new Set();
  candidates.add(norm(user));
  candidates.add(norm(expandNumerics(user)));

  // Also try replacing each time/year token individually and collect all combos
  // For time: generate ALL word candidates and try each substitution
  const timeMatches = [...user.matchAll(/\b(\d{1,2}:\d{2})\b/g)];
  const yearMatches = [...user.matchAll(/\b(1[0-9]{3}|20[0-9]{2})\b/g)];
  const ampmMatches = [...user.matchAll(/\b(\d{1,2})\s*(am|pm)\b/gi)];

  timeMatches.forEach(m => {
    const allWords = timeToWords(m[1]);
    allWords.forEach(w => {
      candidates.add(norm(user.replace(m[1], w)));
    });
  });
  yearMatches.forEach(m => {
    const allWords = yearToWords(parseInt(m[1]));
    allWords.forEach(w => {
      candidates.add(norm(user.replace(m[1], w)));
    });
  });
  ampmMatches.forEach(m => {
    candidates.add(norm(user.replace(m[0], `${_nw(parseInt(m[1]))} o clock`)));
  });

  const ct = c.split(/\s+/).filter(Boolean);
  for (const u of candidates) {
    if (u === c) return true;
    const ut = u.split(/\s+/).filter(Boolean);
    if (ct.every(t => ut.includes(t))) return true;
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t) {
  tab = t;
  document.querySelectorAll('.tab').forEach((el,i)=>el.classList.toggle('active',i===t));
  document.getElementById('sentenceDisplay').style.display = t===1?'block':'none';
  const ph = buildPlaceholder();
  document.getElementById('answerInput').placeholder = ph;
  loadItem();
}

function buildPlaceholder(){
  const ex = [];
  if(components.weekday) ex.push('Monday');
  if(components.date) ex.push('March 15th');
  if(components.year) ex.push('nineteen eighty-four');
  if(components.time) ex.push('half past three');
  return 'e.g. ' + ex.join(', ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadItem() {
  answered = false;
  const inp = document.getElementById('answerInput');
  inp.value=''; inp.className='answer-input';
  document.getElementById('resultBox').style.display='none';
  document.getElementById('submitBtn').textContent='âœ“ Submit';
  inp.placeholder = buildPlaceholder();

  const h=hist[tab], idx=hIdx[tab];
  let item;
  if(idx < h.length-1){ hIdx[tab]++; item=h[hIdx[tab]]; }
  else {
    item = tab===0 ? buildPhrase() : buildSentence();
    h.push(item); hIdx[tab]=h.length-1;
  }
  document.getElementById('itemIndex').textContent = hIdx[tab]+1;
  document.getElementById('prevBtn').disabled = hIdx[tab]<=0;
  if(tab===1) document.getElementById('sentenceDisplay').innerHTML = item.display||'';
  inp.focus();
  TTS.setStatus('ok','âœ“ New question loaded. Click â–¶ to play.');
}

function prevItem() {
  if(hIdx[tab]<=0) return;
  hIdx[tab]--;
  answered=false;
  const inp=document.getElementById('answerInput');
  inp.value=''; inp.className='answer-input';
  document.getElementById('resultBox').style.display='none';
  document.getElementById('submitBtn').textContent='âœ“ Submit';
  const item=cur();
  document.getElementById('itemIndex').textContent=hIdx[tab]+1;
  document.getElementById('prevBtn').disabled=hIdx[tab]<=0;
  if(tab===1) document.getElementById('sentenceDisplay').innerHTML=item.display||'';
  inp.focus();
  TTS.setStatus('ok','âœ“ Previous question. Click â–¶ to play.');
}

function nextItem(){ loadItem(); }

function skipItem() {
  const item = cur();
  if (!item) { loadItem(); return; }

  // Get the correct answer text
  const correct = item.type === 'sentence' ? item.phraseText : item.text;

  // Fill input with correct answer
  const inp = document.getElementById('answerInput');
  inp.value = correct;
  inp.className = 'answer-input wrong';

  // Reveal sentence blank if needed
  if (item.type === 'sentence') {
    const rev = item.display.replace(
      '<span class="blank">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>',
      `<span class="revealed">${esc(item.phraseText)}</span>`
    );
    document.getElementById('sentenceDisplay').innerHTML = rev;
  }

  // Build result HTML showing the correct answer
  let html = '';
  if (item.type === 'sentence') {
    html += `<span class="rl">Full sentence</span>${esc(item.sentence)}`;
  }
  const compKeys = ['weekday','date','year','time'];
  const compLabels = { weekday:'Weekday', date:'Date', year:'Year', time:'Time' };
  const activeComps = compKeys.filter(k => components[k]);
  if (activeComps.length > 1) {
    activeComps.forEach(k => {
      html += `<span class="rl">${compLabels[k]} â€” correct</span><span class="hi-ok">${esc(item.answers[k]||'')}</span>`;
    });
  } else {
    html += `<span class="rl">Correct answer</span><span class="hi-ok">${esc(correct)}</span>`;
  }

  // Show result box as skipped (wrong, no stats counted)
  answered = true;
  lastResultOk = false;
  stats.total++; stats.wrong++;
  document.getElementById('sTotal').textContent = stats.total;
  document.getElementById('sCorrect').textContent = stats.correct;
  document.getElementById('sWrong').textContent = stats.wrong;
  document.getElementById('sRate').textContent = Math.round(stats.correct / stats.total * 100) + '%';
  document.getElementById('totalDone').textContent = stats.total;

  const box = document.getElementById('resultBox');
  box.className = 'result-box wrong';
  box.style.display = 'block';
  document.getElementById('resultTitle').className = 'result-title wrong';
  document.getElementById('resultTitle').textContent = 'â­ Skipped';
  document.getElementById('resultBody').innerHTML = html;
  document.getElementById('submitBtn').textContent = 'â†’ Next';
}
function handlePlay(){ const item=cur(); if(item) TTS.speak(item.speak); }
function updateSpeed(){ TTS.rate=parseFloat(document.getElementById('speedRange').value); document.getElementById('speedVal').textContent=TTS.rate.toFixed(2)+'Ã—'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT & RESULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildResultHtml(val, item) {
  // For both types, the "answer" is the full phrase text
  const correct = item.type==='sentence' ? item.phraseText : item.text;
  const ok = match(val, correct);
  let html = '';

  if(item.type==='sentence'){
    html += `<span class="rl">Full sentence</span>${esc(item.sentence)}`;
  }

  // Show per-component breakdown
  const compKeys = ['weekday','date','year','time'];
  const compLabels = { weekday:'Weekday', date:'Date', year:'Year', time:'Time' };
  const activeComps = compKeys.filter(k=>components[k]);

  if(activeComps.length > 1) {
    // Multi-component: try to match each part of user's input
    // Split user input by comma or common separators
    const userParts = val.split(/,\s*/).map(s=>s.trim()).filter(Boolean);
    // Try to assign user parts to components in order
    let allOk = true;
    activeComps.forEach((k, i) => {
      const correctPart = item.answers[k]||'';
      const userPart = userParts[i]||'';
      const partOk = match(userPart, correctPart);
      if(!partOk) allOk=false;
      html += `<span class="rl">${compLabels[k]} â€” yours</span><span class="${partOk?'hi-ok':'hi-wrong'}">${esc(userPart)||'(empty)'}</span>`;
      if(!partOk) html += `<span class="rl">${compLabels[k]} â€” correct</span><span class="hi-ok">${esc(correctPart)}</span>`;
    });
    return { ok: allOk, html };
  } else {
    // Single component
    html += `<span class="rl">Your answer</span><span class="${ok?'hi-ok':'hi-wrong'}">${esc(val)}</span>`;
    if(!ok) html += `<span class="rl">Correct answer</span><span class="hi-ok">${esc(correct)}</span>`;
    return { ok, html };
  }
}

function submitAnswer() {
  const inp = document.getElementById('answerInput');
  if(answered){ nextItem(); return; }
  const val = inp.value.trim();
  if(!val){ inp.focus(); return; }

  const item = cur();
  const { ok, html } = buildResultHtml(val, item);
  answered=true; lastResultOk=ok;

  // Reveal sentence blank
  if(item.type==='sentence'){
    const rev = item.display.replace(
      '<span class="blank">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>',
      `<span class="revealed">${esc(item.phraseText)}</span>`
    );
    document.getElementById('sentenceDisplay').innerHTML=rev;
  }

  stats.total++; if(ok) stats.correct++; else stats.wrong++;
  document.getElementById('sTotal').textContent=stats.total;
  document.getElementById('sCorrect').textContent=stats.correct;
  document.getElementById('sWrong').textContent=stats.wrong;
  document.getElementById('sRate').textContent=Math.round(stats.correct/stats.total*100)+'%';
  document.getElementById('totalDone').textContent=stats.total;

  inp.classList.add(ok?'correct':'wrong');
  const box=document.getElementById('resultBox');
  box.className='result-box '+(ok?'correct':'wrong');
  box.style.display='block';
  document.getElementById('resultTitle').className='result-title '+(ok?'correct':'wrong');
  document.getElementById('resultTitle').textContent=ok?'âœ… Correct!':'âŒ Wrong';
  document.getElementById('resultBody').innerHTML=html;
  document.getElementById('submitBtn').textContent='â†’ Next';
}

document.getElementById('answerInput').addEventListener('input', ()=>{
  if(!answered) return;
  stats.total--; if(lastResultOk) stats.correct--; else stats.wrong--;
  stats.total=Math.max(0,stats.total); stats.correct=Math.max(0,stats.correct); stats.wrong=Math.max(0,stats.wrong);
  document.getElementById('sTotal').textContent=stats.total;
  document.getElementById('sCorrect').textContent=stats.correct;
  document.getElementById('sWrong').textContent=stats.wrong;
  document.getElementById('sRate').textContent=stats.total>0?Math.round(stats.correct/stats.total*100)+'%':'â€”';
  document.getElementById('totalDone').textContent=stats.total;
  answered=false;
  document.getElementById('answerInput').className='answer-input';
  document.getElementById('resultBox').style.display='none';
  document.getElementById('submitBtn').textContent='âœ“ Submit';
  if(tab===1){ const item=cur(); if(item) document.getElementById('sentenceDisplay').innerHTML=item.display||''; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e=>{
  const inInput = document.activeElement===document.getElementById('answerInput');
  if(e.ctrlKey&&!e.shiftKey&&!e.altKey&&!['z','y','a','c','v','x'].includes(e.key)){
    e.preventDefault(); handlePlay(); return;
  }
  if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); return; }
  if(!inInput){
    if(e.key==='ArrowLeft'){ e.preventDefault(); prevItem(); }
    if(e.key==='ArrowRight'){ e.preventDefault(); nextItem(); }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', ()=>{
  TTS.init();
  updateHint();
  loadItem();
});
</script>
</body>
</html>
